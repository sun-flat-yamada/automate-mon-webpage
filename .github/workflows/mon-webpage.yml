name: Webpage Monitor

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LINE_MESSAGING_API_TOKEN: ${{ secrets.LINE_MESSAGING_API_TOKEN }}
      LINE_BOT_USER_ID: ${{ secrets.LINE_BOT_USER_ID }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies (pup, jq, Chromium)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq chromium-browser unzip fonts-noto-cjk

          # Install pup (HTML parser)
          # Try downloading latest release, fallback to building from source
          echo "Installing pup..."

          # Get the latest release URL
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/ericchiang/pup/releases/latest | jq -r '.assets[] | select(.name | contains("linux_amd64")) | .browser_download_url' | head -1)

          if [ -n "$LATEST_RELEASE" ] && wget -q "$LATEST_RELEASE" -O /tmp/pup.zip; then
            echo "Extracting pup from release..."
            unzip -q /tmp/pup.zip -d /tmp
            sudo mv /tmp/pup /usr/local/bin/pup
            sudo chmod +x /usr/local/bin/pup
            rm -f /tmp/pup.zip
          else
            echo "Building pup from source..."
            sudo apt-get install -y golang-go git
            cd /tmp && git clone https://github.com/ericchiang/pup.git
            cd pup && go build -o pup .
            sudo mv pup /usr/local/bin/
            sudo chmod +x /usr/local/bin/pup
          fi

          pup --version

          # Install Node.js dependencies
          npm ci

      - name: Process all targets
        shell: bash
        run: |
          set -e -o pipefail

          TARGET_COUNT=$(jq '.targets | length' config.json)

          for i in $(seq 0 $(($TARGET_COUNT - 1))); do
            echo "=== Processing target index $i ==="

            TARGET_NAME=$(jq -r ".targets[$i].name" config.json)
            TARGET_URL=$(jq -r ".targets[$i].url" config.json)
            TARGET_SELECTOR=$(jq -r ".targets[$i].selector" config.json)
            EXTRACTOR_TYPE=$(jq -r ".targets[$i].extractor_type // \"\"" config.json)

            echo "Target: $TARGET_NAME"

            mkdir -p "history/$TARGET_NAME"

            echo "Fetching page..."
            if ! curl -sL "$TARGET_URL" -o page.html; then
              echo "ERROR: Failed to fetch $TARGET_URL"
              continue
            fi

            echo "Extracting section..."
            if [ -z "$TARGET_SELECTOR" ]; then
              echo "No selector specified, using full page HTML"
              cp page.html section.html
            else
              if ! pup "$TARGET_SELECTOR html{}" < page.html > section.html; then
                echo "ERROR: Failed to extract selector from $TARGET_URL"
                continue
              fi
            fi

            echo "Computing hash..."
            NEW_HASH=$(sha256sum section.html | awk '{print $1}')
            echo "$NEW_HASH" > new_hash.txt

            CHANGED=false
            LAST_HASH_FILE="history/$TARGET_NAME/last_hash.txt"
            if [ ! -f "$LAST_HASH_FILE" ]; then
              CHANGED=true
            elif ! cmp -s new_hash.txt "$LAST_HASH_FILE"; then
              CHANGED=true
            fi

            if [ "$CHANGED" = true ]; then
              echo "Change detected for $TARGET_NAME"

              TIMESTAMP=$(date +"%Y-%m-%d-%H%M%S")
              TIMESTAMP_YEAR_MONTH=${TIMESTAMP:0:7}
              BASE_DIR="history/${TARGET_NAME}/${TIMESTAMP_YEAR_MONTH}/${TIMESTAMP}"
              mkdir -p "$BASE_DIR"

              echo "Taking screenshot..."
              # Run main.js (TS build).
              if TARGET_URL="$TARGET_URL" TARGET_SELECTOR="$TARGET_SELECTOR" EXTRACTOR_TYPE="$EXTRACTOR_TYPE" node dist/main.js; then
                echo "Screenshot success"
              else
                echo "Warning: main.js returned error"
              fi

              if [ -f section.png ]; then
                  cp section.png "$BASE_DIR/" || echo "Warning: Failed to copy screenshot"
              else
                  echo "Warning: No screenshot file created"
              fi

              if [ -f data.json ]; then
                  cp data.json "$BASE_DIR/" || echo "Warning: Failed to copy data.json"
              fi

              cp section.html "$BASE_DIR/"


              DETECTED_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              DETECTED_TIME_JST=$(TZ=Asia/Tokyo date +"%Y-%m-%dT%H:%M:%S+09:00")
              echo "Detected at: $DETECTED_TIME" > "$BASE_DIR/meta.txt"
              echo "Detected at (JST): $DETECTED_TIME_JST" >> "$BASE_DIR/meta.txt"
              echo "URL: $TARGET_URL" >> "$BASE_DIR/meta.txt"
              echo "Selector: $TARGET_SELECTOR" >> "$BASE_DIR/meta.txt"
              echo "Hash: $NEW_HASH" >> "$BASE_DIR/meta.txt"

              echo "Saving new hash..."
              cp new_hash.txt "$LAST_HASH_FILE"

              # === é€šçŸ¥ç”¨ã®å…±é€šå¤‰æ•°ã‚’äº‹å‰è¨ˆç®— ===
              HAS_SCREENSHOT=false
              if [ -f section.png ]; then
                HAS_SCREENSHOT=true
              fi

              PRODUCT_LIST=""
              if [ -f data.json ]; then
                PRODUCT_LIST=$(jq -r '.[] | "- " + .price + " : " + .specifications + " " + .memory + " " + .video_controller + " " + .hdd' data.json | head -n 10)
              fi
              if [ -z "$PRODUCT_LIST" ]; then
                PRODUCT_LIST="No product details extracted"
              fi

              # === Slack é€šçŸ¥ ===
              if [ -n "$SLACK_WEBHOOK_URL" ]; then
                echo "Sending Slack notification..."
                SLACK_DATA="{\"text\":\"ðŸ”” Update detected: *$TARGET_NAME*\\nTime: $DETECTED_TIME_JST (JST)\\n\\n*Products:*\\n$PRODUCT_LIST\"}"
                curl -X POST -H 'Content-type: application/json' \
                  --data "$SLACK_DATA" \
                  "$SLACK_WEBHOOK_URL" || echo "Failed to send Slack notification"
              fi

              # === LINE é€šçŸ¥ ===
              if [ -n "$LINE_MESSAGING_API_TOKEN" ] && [ -n "$LINE_BOT_USER_ID" ]; then
                echo "Sending LINE notification via Messaging API..."

                if [ "$HAS_SCREENSHOT" = true ]; then
                  IMAGE_BASE64=$(base64 -w 0 section.png)
                  LINE_PAYLOAD="{
                    \"to\": \"$LINE_BOT_USER_ID\",
                    \"messages\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ðŸ”” Update detected: $TARGET_NAME\\nTime: $DETECTED_TIME_JST (JST)\\n\\nProducts:\\n$PRODUCT_LIST\"
                      },
                      {
                        \"type\": \"image\",
                        \"originalContentUrl\": \"data:image/png;base64,$IMAGE_BASE64\",
                        \"previewImageUrl\": \"data:image/png;base64,$IMAGE_BASE64\"
                      }
                    ]
                  }"
                else
                  LINE_PAYLOAD="{
                    \"to\": \"$LINE_BOT_USER_ID\",
                    \"messages\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ðŸ”” Update detected: $TARGET_NAME\\nTime: $DETECTED_TIME_JST (JST)\\n\\nProducts:\\n$PRODUCT_LIST\"
                      }
                    ]
                  }"
                fi

                curl -X POST \
                  -H "Authorization: Bearer $LINE_MESSAGING_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$LINE_PAYLOAD" \
                  https://api.line.biz/v2/bot/message/push || echo "Failed to send LINE notification"
              fi

              # === Discord é€šçŸ¥ ===
              if [ -n "$DISCORD_WEBHOOK_URL" ]; then
                echo "Sending Discord notification..."

                DISCORD_PAYLOAD=$(jq -n \
                  --arg title "ðŸ”” Update detected: $TARGET_NAME" \
                  --arg url "$TARGET_URL" \
                  --arg time "$DETECTED_TIME_JST (JST)" \
                  --arg products "$PRODUCT_LIST" \
                  '{
                    embeds: [{
                      title: $title,
                      url: $url,
                      color: 5814783,
                      fields: [
                        { name: "Time (JST)", value: $time, inline: false },
                        { name: "Products", value: ($products | (if length > 1024 then .[0:1020] + "..." else . end)), inline: false }
                      ],
                      image: { url: "attachment://section.png" }
                    }]
                  }')

                # Split comma-separated URLs
                IFS=',' read -ra DISCORD_URLS <<< "$DISCORD_WEBHOOK_URL"
                for WEBHOOK_URL in "${DISCORD_URLS[@]}"; do
                  WEBHOOK_URL=$(echo "$WEBHOOK_URL" | xargs)
                  if [ -z "$WEBHOOK_URL" ]; then continue; fi

                  echo "Sending to Discord webhook..."
                  if [ "$HAS_SCREENSHOT" = true ]; then
                    curl -X POST \
                      -F "payload_json=$DISCORD_PAYLOAD" \
                      -F "file=@section.png" \
                      "$WEBHOOK_URL" || echo "Failed to send Discord notification with image"
                  else
                    curl -X POST -H 'Content-type: application/json' \
                      --data "$(echo "$DISCORD_PAYLOAD" | jq 'del(.embeds[0].image)')" \
                      "$WEBHOOK_URL" || echo "Failed to send Discord notification"
                  fi
                done
              fi

            else
              echo "No change for $TARGET_NAME"
            fi

          done

      - name: Commit and push changes
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
          git add history/
          if git diff --staged --exit-code > /dev/null; then
            echo "No changes to commit"
          else
            git commit -m "Update history for all monitored sites"
            git push origin main
          fi
