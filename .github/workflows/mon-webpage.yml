name: Webpage Monitor

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LINE_MESSAGING_API_TOKEN: ${{ secrets.LINE_MESSAGING_API_TOKEN }}
      LINE_BOT_USER_ID: ${{ secrets.LINE_BOT_USER_ID }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies (pup, jq)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq

          # Install pup (HTML parser)
          # Try downloading latest release, fallback to building from source
          echo "Installing pup..."

          # Get the latest release URL
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/ericchiang/pup/releases/latest | jq -r '.assets[] | select(.name | contains("linux_amd64")) | .browser_download_url' | head -1)

          if [ -n "$LATEST_RELEASE" ] && wget -q "$LATEST_RELEASE" -O /tmp/pup.zip; then
            echo "Extracting pup from release..."
            unzip -q /tmp/pup.zip -d /tmp
            sudo mv /tmp/pup /usr/local/bin/pup
            sudo chmod +x /usr/local/bin/pup
            rm -f /tmp/pup.zip
          else
            echo "Building pup from source..."
            sudo apt-get install -y golang-go git
            cd /tmp && git clone https://github.com/ericchiang/pup.git
            cd pup && go build -o pup .
            sudo mv pup /usr/local/bin/
            sudo chmod +x /usr/local/bin/pup
          fi

          pup --version

          # Install Node.js dependencies
          npm install

      - name: Commit package-lock.json if missing
        run: |
          if [ ! -f package-lock.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "Add package-lock.json for npm cache support"
            git push
          fi

      - name: Create screenshot script
        run: |
          cat > screenshot.js << 'SCRIPT_EOF'
          const puppeteer = require('puppeteer');
          (async () => {
            try {
              const browser = await puppeteer.launch({ headless: "new", args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              await page.goto(process.env.TARGET_URL, { waitUntil: "networkidle2" });

              try {
                // Wait for selector with timeout
                await page.waitForSelector(process.env.TARGET_SELECTOR, { timeout: 10000 });
                const element = await page.$(process.env.TARGET_SELECTOR);
                if (element) {
                  await element.screenshot({ path: 'section.png' });
                } else {
                  console.log("Selector not found");
                  process.exit(1);
                }
              } catch (timeoutError) {
                console.error(`ERROR: Selector "${process.env.TARGET_SELECTOR}" not found within timeout`);
                console.error("Taking full page screenshot for debugging...");

                // Take full page screenshot
                await page.screenshot({ path: 'section.png', fullPage: true });
                console.error("Full page screenshot saved to section.png");

                // Log available elements
                console.error("Available elements sample:");
                const allElements = await page.$$eval('*', els => els.slice(0, 20).map(el => ({ tag: el.tagName, id: el.id, class: el.className })));
                console.error(JSON.stringify(allElements, null, 2));

                process.exit(1);
              }

              await browser.close();
            } catch (e) {
              console.error("Puppeteer error:", e);
              process.exit(1);
            }
          })();
          SCRIPT_EOF

      - name: Process all targets
        shell: bash
        run: |
          set -e -o pipefail

          TARGET_COUNT=$(jq '.targets | length' config.json)

          for i in $(seq 0 $(($TARGET_COUNT - 1))); do
            echo "=== Processing target index $i ==="

            TARGET_NAME=$(jq -r ".targets[$i].name" config.json)
            TARGET_URL=$(jq -r ".targets[$i].url" config.json)
            TARGET_SELECTOR=$(jq -r ".targets[$i].selector" config.json)

            echo "Target: $TARGET_NAME"

            mkdir -p "history/$TARGET_NAME"

            echo "Fetching page..."
            if ! curl -sL "$TARGET_URL" -o page.html; then
              echo "ERROR: Failed to fetch $TARGET_URL"
              continue
            fi

            echo "Extracting section..."
            if [ -z "$TARGET_SELECTOR" ]; then
              echo "No selector specified, using full page HTML"
              cp page.html section.html
            else
              if ! pup "$TARGET_SELECTOR html{}" < page.html > section.html; then
                echo "ERROR: Failed to extract selector from $TARGET_URL"
                continue
              fi
            fi

            echo "Computing hash..."
            NEW_HASH=$(sha256sum section.html | awk '{print $1}')
            echo "$NEW_HASH" > new_hash.txt

            CHANGED=false
            LAST_HASH_FILE="history/$TARGET_NAME/last_hash.txt"
            if [ ! -f "$LAST_HASH_FILE" ]; then
              CHANGED=true
            elif ! cmp -s new_hash.txt "$LAST_HASH_FILE"; then
              CHANGED=true
            fi

            if [ "$CHANGED" = true ]; then
              echo "Change detected for $TARGET_NAME"

              TIMESTAMP=$(date +"%Y-%m-%d-%H%M%S")
              BASE_DIR="history/${TARGET_NAME}/${TIMESTAMP}"
              mkdir -p "$BASE_DIR"

              echo "Taking screenshot..."
              export TARGET_URL
              export TARGET_SELECTOR
              if node screenshot.js; then
                cp section.png "$BASE_DIR/" || echo "Warning: Screenshot file not created"
              else
                echo "Warning: Puppeteer screenshot failed"
              fi

              cp section.html "$BASE_DIR/"

              DETECTED_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo "Detected at: $DETECTED_TIME" > "$BASE_DIR/meta.txt"
              echo "URL: $TARGET_URL" >> "$BASE_DIR/meta.txt"
              echo "Selector: $TARGET_SELECTOR" >> "$BASE_DIR/meta.txt"
              echo "Hash: $NEW_HASH" >> "$BASE_DIR/meta.txt"

              echo "Saving new hash..."
              cp new_hash.txt "$LAST_HASH_FILE"

              if [ -n "$SLACK_WEBHOOK_URL" ]; then
                echo "Sending Slack notification..."
                SLACK_DATA="{\"text\":\"ðŸ”” Update detected: *$TARGET_NAME*\\nHash: \`${NEW_HASH:0:8}\`\\nTime: $DETECTED_TIME\"}"
                curl -X POST -H 'Content-type: application/json' \
                  --data "$SLACK_DATA" \
                  "$SLACK_WEBHOOK_URL" || echo "Failed to send Slack notification"
              fi

              if [ -n "$LINE_MESSAGING_API_TOKEN" ] && [ -n "$LINE_BOT_USER_ID" ]; then
                echo "Sending LINE notification via Messaging API..."

                # Base64 encode section.png for image message
                if [ -f section.png ]; then
                  IMAGE_BASE64=$(base64 -w 0 section.png)
                  # Send message with text and image
                  LINE_PAYLOAD="{
                    \"to\": \"$LINE_BOT_USER_ID\",
                    \"messages\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ðŸ”” Update detected: $TARGET_NAME\\nHash: ${NEW_HASH:0:8}\"
                      },
                      {
                        \"type\": \"image\",
                        \"originalContentUrl\": \"data:image/png;base64,$IMAGE_BASE64\",
                        \"previewImageUrl\": \"data:image/png;base64,$IMAGE_BASE64\"
                      }
                    ]
                  }"
                else
                  # Send text-only message
                  LINE_PAYLOAD="{
                    \"to\": \"$LINE_BOT_USER_ID\",
                    \"messages\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ðŸ”” Update detected: $TARGET_NAME\\nHash: ${NEW_HASH:0:8}\"
                      }
                    ]
                  }"
                fi

                curl -X POST \
                  -H "Authorization: Bearer $LINE_MESSAGING_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$LINE_PAYLOAD" \
                  https://api.line.biz/v2/bot/message/push || echo "Failed to send LINE notification"
              fi

            else
              echo "No change for $TARGET_NAME"
            fi

          done

      - name: Commit and push changes
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
          git add history/
          if git diff --staged --exit-code > /dev/null; then
            echo "No changes to commit"
          else
            git commit -m "Update history for all monitored sites"
            git push origin main
          fi
